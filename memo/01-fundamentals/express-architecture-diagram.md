# Express.js アーキテクチャ図解 - 用語と関係性

## 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                        Express.js サーバー                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    HTTPサーバー                          │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │                ミドルウェアスタック                   │ │ │
│  │  │                                                   │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │ │
│  │  │  │express.json()│  │express.static│  │  カスタム   │ │ │ │
│  │  │  │(JSON解析)   │  │(静的ファイル)│  │ミドルウェア  │ │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │                                                         │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │                     ルーター                         │ │ │
│  │  │                                                   │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │ │
│  │  │  │ GET '/'     │  │GET '/api/   │  │  将来の     │ │ │ │
│  │  │  │(メインページ)│  │health'      │  │ APIルート   │ │ │ │
│  │  │  │             │  │(ヘルスチェック)│  │             │ │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## リクエスト処理の流れ

```
ブラウザ                Express.js サーバー
   │                        │
   │  HTTP Request          │
   ├──────────────────────→ │
   │                        │
   │                        ▼
   │                   ┌─────────────┐
   │                   │HTTPサーバー  │ ← ポート3000で待機
   │                   └─────────────┘
   │                        │
   │                        ▼
   │                ┌──────────────────┐
   │                │ミドルウェア1     │ ← express.json()
   │                │(JSON解析)       │
   │                └──────────────────┘
   │                        │
   │                        ▼
   │                ┌──────────────────┐
   │                │ミドルウェア2     │ ← express.static()
   │                │(静的ファイル配信)│
   │                └──────────────────┘
   │                        │
   │                        ▼
   │                ┌──────────────────┐
   │                │ルーター          │ ← URLパスに応じて分岐
   │                │(パス照合)       │
   │                └──────────────────┘
   │                        │
   │                        ▼
   │                ┌──────────────────┐
   │                │エンドポイント    │ ← 実際の処理を実行
   │                │(コールバック関数)│
   │                └──────────────────┘
   │                        │
   │  HTTP Response         │
   │ ←──────────────────────┤
   │                        │
```

## 各用語の詳細解説

### 1. サーバー
```
┌─────────────────────────────────┐
│           Express.js サーバー     │
│                               │
│  役割:                         │
│  • HTTPリクエストの受信         │
│  • レスポンスの送信             │
│  • ポート3000で待機             │
│                               │
│  コード例:                     │
│  app.listen(3000, () => {     │
│    console.log('Server running') │
│  });                          │
└─────────────────────────────────┘
```

### 2. ミドルウェア
```
リクエスト ──→ ミドルウェア1 ──→ ミドルウェア2 ──→ ルーター ──→ レスポンス
              ↓              ↓              ↓
         express.json()  express.static()  カスタム処理

特徴:
• 順番に実行される
• req, res, next の3つの引数を持つ
• next() で次のミドルウェアに処理を渡す
• 処理を中断することも可能
```

### 3. Express
```
┌─────────────────────────────────────────┐
│              Express.js                 │
│                                       │
│  • Node.js用Webアプリケーションフレームワーク │
│  • HTTPサーバーの機能を簡単に構築        │
│  • ミドルウェアシステム                 │
│  • ルーティング機能                    │
│  • 静的ファイル配信                    │
│                                       │
│  const app = express();               │
│  ↑                                   │
│  Expressアプリケーションインスタンス     │
└─────────────────────────────────────────┘
```

### 4. ルーター
```
URLパス別の処理分岐システム

┌─────────────────────────────────────┐
│            ルーター                  │
│                                   │
│  GET  '/'          → index.html送信 │
│  GET  '/api/health' → JSON応答     │
│  POST '/api/memos'  → メモ作成     │
│  PUT  '/api/memos/1' → メモ更新    │
│  DELETE '/api/memos/1' → メモ削除  │
│                                   │
│  app.get(path, callback)          │
│  app.post(path, callback)         │
│  app.put(path, callback)          │
│  app.delete(path, callback)       │
└─────────────────────────────────────┘
```

### 5. ヘルスチェック用エンドポイント
```
┌─────────────────────────────────────────┐
│        ヘルスチェックエンドポイント          │
│                                       │
│  URL: GET /api/health                 │
│                                       │
│  目的:                                 │
│  • サーバーが正常に動作しているか確認    │
│  • 外部監視システムからの生存確認       │
│  • デプロイ後の動作確認                │
│                                       │
│  レスポンス例:                         │
│  {                                    │
│    "status": "OK",                   │
│    "message": "Server is running"    │
│  }                                   │
└─────────────────────────────────────────┘
```

## 関係性マップ

```
Express.js
    │
    ├── サーバー (HTTPサーバー)
    │     │
    │     └── ポート3000で待機
    │
    ├── ミドルウェアスタック
    │     │
    │     ├── express.json() ── JSON解析
    │     ├── express.static() ── 静的ファイル配信
    │     └── カスタムミドルウェア
    │
    └── ルーター
          │
          ├── GET '/' ── メインページ
          ├── GET '/api/health' ── ヘルスチェック
          └── 将来のAPIエンドポイント
```

## 実際のコード対応

### server.js の各部分
```javascript
const express = require('express');     // ← Express.js読み込み
const app = express();                  // ← Expressアプリ作成

// ミドルウェア設定
app.use(express.json());               // ← ミドルウェア1
app.use(express.static('public'));     // ← ミドルウェア2

// ルーター設定
app.get('/', (req, res) => {           // ← ルート1
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.get('/api/health', (req, res) => { // ← ルート2（ヘルスチェック）
    res.json({ status: 'OK', message: 'Server is running' });
});

// サーバー起動
app.listen(3000, () => {               // ← HTTPサーバー起動
    console.log('Server is running on port 3000');
});
```

## データフロー詳細

### 例: メインページアクセス時
```
1. ブラウザ: http://localhost:3000/ にアクセス
   ↓
2. Express サーバー: リクエスト受信
   ↓
3. ミドルウェア1 (express.json): JSON解析（今回は不要）
   ↓
4. ミドルウェア2 (express.static): 静的ファイルチェック（該当なし）
   ↓
5. ルーター: GET '/' にマッチ
   ↓
6. エンドポイント: index.html ファイルを送信
   ↓
7. ブラウザ: HTMLページを表示
```

### 例: ヘルスチェックアクセス時
```
1. ブラウザ: http://localhost:3000/api/health にアクセス
   ↓
2. Express サーバー: リクエスト受信
   ↓
3. ミドルウェア処理（JSON解析、静的ファイル）
   ↓
4. ルーター: GET '/api/health' にマッチ
   ↓
5. エンドポイント: JSON応答 {"status": "OK", ...}
   ↓
6. ブラウザ: JSON データを受信
```

## Express.js の利点

### 1. 構造化された処理
- ミドルウェアで前処理を統一
- ルーターでURLパス別に処理分岐
- エンドポイントで具体的な処理を実装

### 2. 拡張性
- ミドルウェアの追加・削除が容易
- ルーターのファイル分割が可能
- プラグインシステム

### 3. 保守性
- 処理の流れが明確
- 責任分界点が明確
- デバッグが容易

## 今後の拡張

### APIルーターの分離
```javascript
// routes/memos.js (将来)
const router = express.Router();
router.get('/', getMemos);        // GET /api/memos
router.post('/', createMemo);     // POST /api/memos
router.put('/:id', updateMemo);   // PUT /api/memos/:id
router.delete('/:id', deleteMemo); // DELETE /api/memos/:id

// server.js
app.use('/api/memos', memosRouter);
```

この図解により、Express.js の各要素がどのように連携してWebアプリケーションを構成しているかが理解できます。